import java.security.MessageDigest

Integer.metaClass.getSeconds = { ->
    delegate * 1000
}

project.ext.url = 'https://developer.bitnet.io/assets/raml/bitnet-payment-api.raml'.toURL()

private String latestDevRAML() {
    MessageDigest digest = MessageDigest.getInstance("MD5")
    InputStream is = url.newInputStream(connectTimeout: 10.seconds, readTimeout: 10.seconds,
            useCaches: true, allowUserInteraction: false,
            requestProperties: ['User-Agent': 'Groovy'])

    byte[] buffer = new byte[8192]
    int read = 0
    while ((read = is.read(buffer)) > 0) {
        digest.update(buffer, 0, read);
    }

    byte[] md5sum = digest.digest()
    BigInteger bigInt = new BigInteger(1, md5sum)
    bigInt.toString(16).padLeft(32, '0')
}

private String builtAgainstRAML() {
    Properties props = new Properties()
    File projectProperties = new File('gradle.properties')
    props.load(projectProperties.newDataInputStream())
    return props.getProperty('raml.build')
}

private void updateBuildAgainstRAML(String version) {
    Properties props = new Properties()
    File projectProperties = new File('gradle.properties')
    props.load(projectProperties.newDataInputStream())
    props.setProperty('raml.build', version)
    props.store(projectProperties.newWriter(), null)
}

task checkRAMLBuild() {
    doLast {
        def builtAgainst = builtAgainstRAML()
        def latest = latestDevRAML()

        if (builtAgainst != latest) {
            updateBuildAgainstRAML(latest)
            throw new GradleException("Dev RAML has been updated - " +
                    "\nPlease confirm that no breaking changes have been made to the schema or exposed endpoints." +
                    "\nThen run ./gradlew updateRAMLBuild and commit any changes along with gradle.properties which contains a hash of the latest RAML");
        }
    }
}

task updateRAMLBuild() {
    doLast {
        def builtAgainst = builtAgainstRAML()
        def latest = latestDevRAML()

        if (builtAgainst != latest) {
            InputStream is = url.newInputStream(connectTimeout: 10.seconds, readTimeout: 10.seconds,
                    useCaches: true, allowUserInteraction: false,
                    requestProperties: ['User-Agent': 'Groovy'])
            new FileOutputStream("config/raml/bitnet-payment-api-${new Date().format("yyyy-MM-dd-HHmmss")}-${latest}.raml") << is
            updateBuildAgainstRAML(latest)
        }
    }
}
    }
}



